# 《攻城掠地》桌游项目 - rsyslog配置
# 将此配置添加到 /etc/rsyslog.d/siege-game.conf

# 应用日志配置
$template SiegeGameFormat,"%timegenerated% %HOSTNAME% %syslogtag%%msg:::sp-if-no-1st-sp%%msg:::drop-last-lf%\n"

# 应用日志文件
if $programname == 'siege-game' then {
    /var/log/siege-game/app.log;SiegeGameFormat
    stop
}

# Nginx日志
if $programname == 'nginx' then {
    /var/log/siege-game/nginx.log;SiegeGameFormat
    stop
}

# PM2日志
if $programname == 'PM2' then {
    /var/log/siege-game/pm2.log;SiegeGameFormat
    stop
}

# Docker日志
if $programname == 'dockerd' then {
    /var/log/siege-game/docker.log;SiegeGameFormat
    stop
}

# 系统安全日志
if $programname == 'sshd' or $programname == 'sudo' or $programname == 'su' then {
    /var/log/siege-game/security/auth.log;SiegeGameFormat
    stop
}

# 防火墙日志
if $msg contains 'UFW' then {
    /var/log/siege-game/security/firewall.log;SiegeGameFormat
    stop
}

# Fail2Ban日志
if $programname == 'fail2ban' then {
    /var/log/siege-game/security/fail2ban.log;SiegeGameFormat
    stop
}

# 错误日志聚合
if $syslogseverity <= 3 then {
    /var/log/siege-game/errors.log;SiegeGameFormat
}

# 远程日志发送 (可选)
# *.* @@remote-log-server:514

# 日志文件权限设置
$FileOwner gameapp
$FileGroup gameapp
$FileCreateMode 0644
$DirCreateMode 0755

# 工作目录
$WorkDirectory /var/spool/rsyslog

# 队列配置
$ActionQueueFileName siege-game-queue
$ActionQueueMaxDiskSpace 1g
$ActionQueueSaveOnShutdown on
$ActionQueueType LinkedList
$ActionResumeRetryCount -1